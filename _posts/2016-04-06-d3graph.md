---
layout: post
tags: javascript d3.js visualization graph
category: code
---

<script src="/assets/javascripts/d3graph/d3.min.js" type="text/javascript"></script>
<script src="/assets/javascripts/d3graph/d3graph.js" type="text/javascript"></script>
<script src="/assets/javascripts/d3graph/demo2.js" type="text/javascript"></script>
<div id="main"></div>
<script>
demo();
</script>

之前做图谱搜索，用d3.js做可视化，以图的方式展示后端数据，表现数据之间的关联。最近有时间就把画图这部分比较通用的东西抽象出来，写了一个[d3graph](https://github.com/yihe2/d3graph)。d3graph不仅能够画图，还能够以动画的形式展现出图的变化过程。

因为做图谱搜索的时候，有的顶点可能会很多相邻顶点，如果全部画出来，就会非常乱。于是就实现了交互的折叠/展开功能。但是折叠/展开之后图的布局会改变，直接重绘的话就会发生跳跃，很难看出哪些点是新增的。如果利用动画展示这个变化过程，就会比较清楚。

在以上demo中，我随机生成了一个图，并且不停的随机增删顶点和边。d3graph会自动表现出图的变化的过程，代码在[这里](https://github.com/yihe2/d3graph/blob/master/example/demo2.js)。

最终d3graph做且仅做如下的事情：

1. 只针对有向无环图（DAG）
2. 根据图的拓扑结构自动布局
3. 记录上次绘制的布局，通过动画，展示图的变化过程。

而具体如何可视化一个顶点或者一条边，由自定义的回调函数负责。

通过几个简单的接口对图进行修改后，调用redraw函数进行绘制。d3graph首先进行拓扑排序，按照层级结构，从左到右对点进行布局。同一层的点横坐标是相同的，均匀分布在container上。接下来需要对同一层的顶点进行排序，以使得边的交叉尽量少。我采用一种比较简单的迭代优化方法，优化相邻顶点的纵坐标之差。这当然不是最优解，但结果看上去还不错，计算也比较高效。如果两个顶点到起始点的距离相等，他们就会出现在同一层，尽管这两个点可能有先后关系。因此有的边可能连接的是同一层的两个点，但是这样做有一个好处就是所有边只会连接相邻或相同的层，画起来会清晰一些。两个点之间可以有多条边，这时d3graph会用不同的曲线来表达这些边，以便他们能互相区别开来。
